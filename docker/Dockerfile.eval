# Dockerfile.eval - Evaluation image for NeMo Evaluator
#
# CUDA Version Configuration:
# - Default: 12.4.1 (compatible with current NeMo releases)
# - Override: docker build --build-arg CUDA_VERSION=12.1.1 ...

ARG CUDA_VERSION=12.4.1
ARG CUDNN_VERSION=9
ARG UBUNTU_VERSION=22.04

FROM nvidia/cuda:${CUDA_VERSION}-cudnn${CUDNN_VERSION}-runtime-ubuntu${UBUNTU_VERSION}

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Python and Node versions
ARG PYTHON_VERSION=3.11
ARG NODE_VERSION=24

# Labels
LABEL maintainer="Your Name <your.email@example.com>"
LABEL description="GPT-OSS TypeScript Post-Training - Evaluation Image"
LABEL cuda.version="${CUDA_VERSION}"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    wget \
    ca-certificates \
    software-properties-common \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-dev \
    python${PYTHON_VERSION}-venv \
    python${PYTHON_VERSION}-distutils \
    && rm -rf /var/lib/apt/lists/*

# Set Python aliases
RUN update-alternatives --install /usr/bin/python python /usr/bin/python${PYTHON_VERSION} 1 \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${PYTHON_VERSION} 1

# Install pip
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python${PYTHON_VERSION}

# Install Node.js (for repo-based evaluation)
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g pnpm

# Install uv
RUN pip install uv

# Set working directory
WORKDIR /app

# Copy project files
COPY pyproject.toml .
COPY src/ src/
COPY scripts/ scripts/
COPY configs/ configs/

# Install dependencies (without vLLM - that's for serving)
RUN uv pip install --system -e ".[dev]"

# Install evaluation frameworks
RUN pip install \
    evaluate \
    lm-eval \
    bigcode-evaluation-harness || true

# Create directories
RUN mkdir -p /app/data /app/outputs/eval

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import src.eval.nemo_eval_runner" || exit 1

# Default command
CMD ["python", "-m", "src.eval.nemo_eval_runner", "--help"]
